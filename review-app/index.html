<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾©ç¿’ã‚µãƒãƒ¼ã‚¿ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆè‰ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .heatmap-container { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
        .heatmap-day { width: 15px; height: 15px; border-radius: 2px; background-color: #ebedf0; border: 1px solid #e1e4e8; }
        /* è‰²ã®æ¿ƒã•ãƒ¬ãƒ™ãƒ« */
        .level-1 { background-color: #9be9a8; }
        .level-2 { background-color: #40c463; }
        .level-3 { background-color: #30a14e; }
        .level-4 { background-color: #216e39; }
        .heatmap-label { font-size: 0.75rem; text-align: center; color: #666; width: 100%; margin-bottom: 5px; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input { width: calc(100% - 24px); padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        button#add-btn { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: background 0.2s; }
        button#add-btn:hover { background-color: #0056b3; }

        /* ãƒªã‚¹ãƒˆ */
        ul { list-style: none; padding: 0; }
        li { background: white; border-left: 6px solid #28a745; margin-bottom: 12px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        li.urgent { border-left-color: #dc3545; background-color: #fff5f5; }
        
        .meta { font-size: 0.85em; color: #666; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .delete-btn { background: none; border: none; color: #999; cursor: pointer; font-size: 1.2rem; padding: 0 5px; }
        .delete-btn:hover { color: #dc3545; }

        /* è©•ä¾¡ãƒœã‚¿ãƒ³ */
        .action-buttons { display: flex; gap: 8px; }
        .btn-review { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9rem; transition: opacity 0.2s; }
        .btn-review:hover { opacity: 0.9; }
    </style>
</head>
<body>

    <h1>ğŸ“š å¾©ç¿’ã‚µãƒãƒ¼ã‚¿ãƒ¼</h1>

    <div class="card">
        <div class="heatmap-label">ğŸ”¥ éå»30æ—¥é–“ã®å­¦ç¿’è¨˜éŒ² (ç¶™ç¶šã¯åŠ›ãªã‚Šï¼)</div>
        <div id="heatmap" class="heatmap-container"></div>
    </div>

    <div class="card">
        <h3>ğŸ“Š ä»Šå¾Œ1é€±é–“ã®äºˆå®š</h3>
        <canvas id="reviewChart"></canvas>
    </div>

    <div class="card">
        <h3>âœï¸ æ–°ã—ã„å­¦ç¿’ã‚’è¨˜éŒ²</h3>
        <input type="text" id="bookName" placeholder="æ•™æå (ä¾‹: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900)">
        <input type="text" id="pageRange" placeholder="ç¯„å›² (ä¾‹: P.30ã€œ35)">
        <button id="add-btn" onclick="addItem()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <h3>ğŸ“… ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§</h3>
    <ul id="review-list"></ul>

    <script>
        // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† & ä¿å­˜æ©Ÿèƒ½ ---
        let studyItems = [];
        let studyLogs = {}; // æ—¥ä»˜ã”ã¨ã®å¾©ç¿’å›æ•°ã‚’è¨˜éŒ² { "2025-12-10": 5, ... }
        let myChart = null;

        // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        window.onload = function() {
            loadData();
            updateUI();
        };

        function saveData() {
            localStorage.setItem('srs_items', JSON.stringify(studyItems));
            localStorage.setItem('srs_logs', JSON.stringify(studyLogs));
        }

        function loadData() {
            const items = localStorage.getItem('srs_items');
            const logs = localStorage.getItem('srs_logs');
            if (items) studyItems = JSON.parse(items);
            if (logs) studyLogs = JSON.parse(logs);
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        };

        // --- 2. ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ† ---

        function addItem() {
            const bookName = document.getElementById('bookName').value;
            const pageRange = document.getElementById('pageRange').value;
            if (!bookName || !pageRange) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");

            const newItem = {
                id: Date.now(),
                book: bookName,
                range: pageRange,
                repetition: 0,
                interval: 0,
                easeFactor: 2.5,
                nextReview: getToday()
            };

            studyItems.push(newItem);
            saveData(); // ä¿å­˜
            updateUI();
            
            document.getElementById('bookName').value = '';
            document.getElementById('pageRange').value = '';
        }

        // â˜…å‰Šé™¤æ©Ÿèƒ½
        function deleteItem(id) {
            if (confirm("ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                studyItems = studyItems.filter(item => item.id !== id);
                saveData(); // ä¿å­˜
                updateUI();
            }
        }

        function reviewItem(id, quality) {
            const item = studyItems.find(i => i.id === id);
            
            // SM-2 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
            if (quality < 3) {
                item.repetition = 0;
                item.interval = 1;
            } else {
                if (item.repetition === 0) item.interval = 1;
                else if (item.repetition === 1) item.interval = 6;
                else item.interval = Math.ceil(item.interval * item.easeFactor);
                item.repetition += 1;
            }

            item.easeFactor = item.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (item.easeFactor < 1.3) item.easeFactor = 1.3;

            item.nextReview = addDays(getToday(), item.interval);

            // â˜…ãƒ­ã‚°ã‚’è¨˜éŒ²ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨ï¼‰
            const today = getToday();
            if (!studyLogs[today]) studyLogs[today] = 0;
            studyLogs[today]++;

            saveData(); // ä¿å­˜
            updateUI();
        }

        // --- 3. UIæ›´æ–° ---

        function updateUI() {
            renderList();
            renderChart();
            renderHeatmap();
        }

        function renderList() {
            const listEl = document.getElementById('review-list');
            listEl.innerHTML = '';
            studyItems.sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview));

            studyItems.forEach(item => {
                const isUrgent = item.nextReview <= getToday();
                const dateText = isUrgent ? "ä»Šæ—¥ã‚„ã‚‹ï¼" : `æ¬¡ã¯ ${item.nextReview}`;
                
                const html = `
                    <li class="${isUrgent ? 'urgent' : ''}">
                        <div class="meta">
                            <span>æ¬¡å›: <strong>${dateText}</strong> (é–“éš”: ${item.interval}æ—¥)</span>
                            <button class="delete-btn" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                        </div>
                        <div class="title">ğŸ“˜ ${item.book} : ${item.range}</div>
                        ${isUrgent ? `
                        <div class="action-buttons">
                            <button class="btn-review" style="background:#dc3545;" onclick="reviewItem(${item.id}, 0)">å¿˜ã‚ŒãŸ</button>
                            <button class="btn-review" style="background:#ffc107; color:black;" onclick="reviewItem(${item.id}, 3)">é›£ã—ã„</button>
                            <button class="btn-review" style="background:#28a745;" onclick="reviewItem(${item.id}, 5)">ç°¡å˜</button>
                        </div>
                        ` : ''}
                    </li>
                `;
                listEl.innerHTML += html;
            });
        }

        // â˜…ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”» (éå»30æ—¥åˆ†)
        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            
            // ä»Šæ—¥ã‹ã‚‰30æ—¥å‰ã¾ã§é¡ã‚‹
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const count = studyLogs[dateStr] || 0;
                
                // è‰²ã®æ¿ƒã•ã‚’æ±ºå®š
                let level = 'heatmap-day';
                if (count >= 10) level += ' level-4';
                else if (count >= 5) level += ' level-3';
                else if (count >= 3) level += ' level-2';
                else if (count >= 1) level += ' level-1';
                
                const div = document.createElement('div');
                div.className = level;
                div.title = `${dateStr}: ${count}å›å¾©ç¿’`; // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§è©³ç´°
                container.appendChild(div);
            }
        }

        // æ£’ã‚°ãƒ©ãƒ•æç”»
        function renderChart() {
            const ctx = document.getElementById('reviewChart').getContext('2d');
            const labels = [];
            const dataCounts = [];
            
            for (let i = 0; i < 7; i++) {
                const d = addDays(getToday(), i);
                labels.push(i === 0 ? 'ä»Šæ—¥' : d.slice(5)); 
                let count = 0;
                if (i === 0) {
                    count = studyItems.filter(item => item.nextReview <= d).length;
                } else {
                    count = studyItems.filter(item => item.nextReview === d).length;
                }
                dataCounts.push(count);
            }

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¾©ç¿’ã‚«ãƒ¼ãƒ‰æ•°',
                        data: dataCounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }
    </script>
</body>
</html>
